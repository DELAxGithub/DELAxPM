# DELA×PM統合システム - Supabase無料枠制約下での統合戦略

## 概要

Supabase無料枠（最大2プロジェクト）の制約下で、稼働中のPMplattoとPMliberaryを安全に統合するための包括的戦略です。

## 現状分析

### 稼働中システム
1. **PMplatto**: ラジオ番組管理システム
   - 9段階進捗管理（キャスティング中 → 請求済）
   - PR管理機能
   - 週次レビュー機能
   - Slack通知連携

2. **PMliberary**: リベラリー管理システム
   - 10段階エピソード管理（台本作成中 → 完パケ納品）
   - チームダッシュボード
   - インタビュー・VTR分類
   - より柔軟なデータベース設計

### 制約条件
- **Supabase無料枠制限**: 最大2プロジェクト
- **新規プロジェクト作成不可**: 3つ目のプロジェクト追加不可
- **本番稼働中**: 両システムとも稼働中でダウンタイム最小化が必須
- **データ保全**: 業務データの完全性保持が絶対条件

## 統合戦略の選択

### 推奨戦略: PMliberaryベース統合

**選択理由:**

#### 1. 技術的優位性
- **進化したデータベース設計**: より柔軟で拡張性の高いスキーマ
- **先進機能**: 10段階ステータス、ダッシュボード、チームイベント管理
- **モダンなアーキテクチャ**: 最新の開発パターンとベストプラクティス
- **Edge Functions**: Supabase最新機能の活用

#### 2. 機能的な包括性
- PMliberaryの機能セットがPMplattoを包含
- エピソード管理がプログラム管理より詳細
- ダッシュボード機能による統合管理の基盤
- チーム協業機能の充実

#### 3. 移行の実現性
- PMplattoのシンプルなデータ構造をPMliberaryに統合しやすい
- project_type識別による両システムデータの共存可能
- 段階的移行によるリスク最小化

#### 4. 運用面での利点
- より活発な開発・更新履歴
- 充実したドキュメント（CLAUDE.md等）
- テスト・CI/CD環境の整備

### 代替案の検討

#### PMplattoベース統合（非推奨）
**問題点:**
- シンプルすぎるデータ構造でPMliberary機能を収容困難
- ダッシュボード機能の実装が一から必要
- エピソード管理の複雑性を吸収できない
- 統合後の拡張性に制限

#### 新規プロジェクト作成（不可能）
- Supabase無料枠制限により実行不可
- 有料プラン移行のコスト発生

## 移行フェーズ計画

### Phase 0: 事前準備（1-2日）
**目的**: 移行作業の基盤整備と安全性確保

#### 実施内容
1. **完全データバックアップ**
   - PMplatto全データのSQLダンプ作成
   - PMliberary全データのSQLダンプ作成
   - メタデータ・権限・設定情報の保存
   - 複数世代バックアップの作成

2. **統合スキーマ準備**
   - 統合データベーススキーマの最終調整
   - project_type識別機能の実装
   - インデックス・制約の最適化

3. **テスト環境構築**
   - ローカル環境での統合テスト
   - データ移行スクリプトの動作確認
   - ロールバック手順の検証

#### 成功判定基準
- [ ] 両システムの完全バックアップ取得完了
- [ ] 統合スキーマの動作確認完了
- [ ] テスト環境での移行スクリプト実行成功
- [ ] ロールバック手順の動作確認完了

### Phase 1: PMliberary統合準備（2-3日）
**目的**: PMliberaryを統合版の基盤として拡張

#### 実施内容
1. **データベーススキーマ拡張**
   ```sql
   -- project_type列の追加
   ALTER TABLE programs ADD COLUMN project_type text DEFAULT 'liberary';
   ALTER TABLE episodes ADD COLUMN project_type text DEFAULT 'liberary';
   
   -- PMplatto用フィールドの追加
   ALTER TABLE programs ADD COLUMN pr_80text text;
   ALTER TABLE programs ADD COLUMN pr_200text text;
   ALTER TABLE programs ADD COLUMN pr_completed boolean DEFAULT false;
   ```

2. **統合ステータスマスターの構築**
   - PMplatto用9段階ステータスの追加
   - PMliberary用10段階ステータスの保持
   - 統合版用新ステータスの定義

3. **アプリケーション拡張**
   - project_type識別機能の実装
   - PMplatto機能の段階的実装
   - 統合ダッシュボードの準備

#### 成功判定基準
- [ ] 統合スキーマの適用完了
- [ ] 既存PMliberaryデータの完全性確認
- [ ] project_type識別機能の動作確認
- [ ] PMplatto機能プロトタイプの動作確認

### Phase 2: データ移行実行（メンテナンス時間: 4-6時間）
**目的**: PMplattoデータの安全な統合版への移行

#### 実施スケジュール
```
土曜日 22:00-04:00 (メンテナンス時間)
22:00-22:30  最終バックアップ・事前確認
22:30-23:30  PMplattoデータ移行実行
23:30-01:00  データ整合性チェック・検証
01:00-02:30  アプリケーション機能テスト
02:30-03:30  ユーザー受け入れテスト
03:30-04:00  最終確認・サービス復旧
```

#### 実施内容
1. **事前確認**
   - 両システムの最新バックアップ取得
   - 移行スクリプトの最終確認
   - 監視体制の準備

2. **データ移行**
   ```sql
   -- PMplattoデータの統合版への移行
   INSERT INTO programs (
     title, subtitle, current_status, project_type,
     first_air_date, cast1, cast2, director,
     pr_80text, pr_200text, pr_completed,
     source_system, migrated_at, legacy_id
   ) SELECT 
     title, subtitle, status, 'platto',
     first_air_date, cast1, cast2, director,
     pr_80text, pr_200text, pr_completed,
     'platto', now(), id::text
   FROM platto_programs;
   ```

3. **整合性チェック**
   - レコード数の一致確認
   - データ型・制約の検証
   - 関連データの整合性確認

4. **機能テスト**
   - PMplatto機能の動作確認
   - PMliberary機能の継続動作確認
   - 統合ダッシュボードの動作確認

#### 成功判定基準
- [ ] PMplattoデータ移行完了（データ損失0件）
- [ ] 全機能の正常動作確認
- [ ] パフォーマンス基準の達成
- [ ] ユーザー受け入れテスト合格

### Phase 3: 統合版サービス開始（1日）
**目的**: 統合版の本格運用開始と最終確認

#### 実施内容
1. **サービス切り替え**
   - DNS・URLルーティングの変更
   - ユーザー案内・トレーニング
   - 監視体制の強化

2. **運用確認**
   - 24時間監視体制
   - ユーザーフィードバックの収集
   - パフォーマンス監視

3. **PMplattoプロジェクト整理**
   - 統合版の安定稼働確認後
   - PMplattoプロジェクトの削除
   - リソース最適化

#### 成功判定基準
- [ ] 統合版の安定稼働（24時間以上）
- [ ] ユーザー満足度の維持
- [ ] システムパフォーマンスの維持
- [ ] PMplattoプロジェクト削除完了

## リスク管理

### 主要リスク

#### 1. データ損失リスク
**影響度**: 致命的
**発生確率**: 低
**対策**:
- 複数世代バックアップの必須化
- 移行前後でのデータ整合性チェック
- 段階的移行による影響範囲限定

#### 2. サービス停止リスク
**影響度**: 高
**発生確率**: 中
**対策**:
- 最大6時間のメンテナンス時間確保
- 迅速なロールバック手順の準備
- 24時間サポート体制の確立

#### 3. 機能劣化リスク
**影響度**: 中
**発生確率**: 中
**対策**:
- 事前の機能テスト徹底
- ユーザー受け入れテスト実施
- 段階的機能リリース

#### 4. パフォーマンス劣化リスク
**影響度**: 中
**発生確率**: 低
**対策**:
- インデックス最適化
- クエリパフォーマンスチューニング
- 監視・アラート体制強化

### 緊急時対応

#### レベル1: 軽微な問題
- ログによる原因調査
- オンライン修正
- 影響範囲の限定

#### レベル2: 中程度の問題
- 部分的ロールバック実行
- 影響機能の一時停止
- 修正後の段階的復旧

#### レベル3: 重大な問題
- 完全ロールバック実行
- 元システムへの即座復旧
- 根本原因調査・対策立案

## 成功指標とKPI

### 技術指標
- **データ完全性**: 移行データ損失 0件
- **可用性**: アップタイム 99.9%以上
- **パフォーマンス**: レスポンス時間 2秒以内維持
- **機能性**: 全機能正常動作率 100%

### ビジネス指標
- **ユーザー満足度**: 移行前後で満足度維持
- **生産性**: 業務効率の向上
- **コスト効率**: 運用コスト削減
- **拡張性**: 新機能追加の容易性向上

### 運用指標
- **ダウンタイム**: 6時間以内
- **復旧時間**: 問題発生から30分以内
- **エラー率**: 0.1%以下
- **サポート対応**: 平均応答時間30分以内

## 実装リソース

### 必要スキル
- Supabase/PostgreSQL管理
- データベースマイグレーション
- Next.js/React開発
- DevOps・インフラ管理

### 推定工数
- **Phase 0**: 16-24時間（2-3日）
- **Phase 1**: 24-32時間（3-4日）
- **Phase 2**: 6-8時間（メンテナンス日）
- **Phase 3**: 8-16時間（1-2日）
- **総計**: 54-80時間（1-2週間）

### チーム体制
- **プロジェクトマネージャー**: 1名
- **データベースエンジニア**: 1名
- **フロントエンドエンジニア**: 1名
- **QAエンジニア**: 1名

## 結論

PMliberaryベースの統合戦略は、技術的・機能的・運用的な観点から最適な選択です。この戦略により、Supabase無料枠の制約下でも安全かつ効率的な統合が実現できます。

重要なのは段階的なアプローチによるリスク最小化と、各段階での十分な検証です。この戦略を着実に実行することで、より強力で統合された進捗管理システムが構築できます。