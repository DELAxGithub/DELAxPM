name: ğŸ§ª Quality Check & Testing
on:
  pull_request:
    branches: [ master, main ]
  push:
    branches: [ feature/*, develop, staging ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - e2e
        - lint
        - type-check

# Environment variables
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

jobs:
  # ===================================
  # CODE QUALITY CHECKS
  # ===================================
  code-quality:
    name: ğŸ“‹ Code Quality
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.check-changes.outputs.should_test }}
    
    steps:
      # Checkout code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better change detection
      
      # Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Setup pnpm
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # Cache dependencies
      - name: ğŸ“‚ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            apps/unified/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      
      # Install dependencies
      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile
      
      # Detect changes
      - name: ğŸ” Detect Changes
        id: check-changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_test=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - running all tests"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_test=true" >> $GITHUB_OUTPUT
            echo "Pull request - running all tests"
          else
            # Check for changes in relevant files
            changed_files=$(git diff --name-only HEAD~1 HEAD)
            if echo "$changed_files" | grep -E "\.(ts|tsx|js|jsx|json|md)$|package\.json|pnpm-lock\.yaml" > /dev/null; then
              echo "should_test=true" >> $GITHUB_OUTPUT
              echo "Relevant files changed - running tests"
            else
              echo "should_test=false" >> $GITHUB_OUTPUT
              echo "No relevant files changed - skipping tests"
            fi
          fi
      
      # TypeScript type checking
      - name: ğŸ” TypeScript Type Check
        if: steps.check-changes.outputs.should_test == 'true' && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'type-check' || github.event.inputs.test_type == '')
        run: |
          echo "ğŸ” Running TypeScript type checking..."
          pnpm type-check
          echo "âœ… Type checking completed"
      
      # ESLint checking
      - name: ğŸ§¹ ESLint Check
        if: steps.check-changes.outputs.should_test == 'true' && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'lint' || github.event.inputs.test_type == '')
        run: |
          echo "ğŸ§¹ Running ESLint..."
          pnpm lint
          echo "âœ… Linting completed"
      
      # Build check (for early detection of build issues)
      - name: ğŸ—ï¸ Build Check
        if: steps.check-changes.outputs.should_test == 'true' && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == '')
        run: |
          echo "ğŸ—ï¸ Testing build process..."
          pnpm build:unified
          echo "âœ… Build check completed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'dummy-url' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}
          NEXT_PUBLIC_APP_NAME: "DELAÃ—PMçµ±åˆã‚·ã‚¹ãƒ†ãƒ "
          NEXT_PUBLIC_ENABLE_PLATTO: "true"
          NEXT_PUBLIC_ENABLE_LIBERARY: "true"
          NEXT_PUBLIC_ENABLE_GUEST_ACCESS: "true"

  # ===================================
  # UNIT TESTS (if they exist)
  # ===================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    if: needs.code-quality.outputs.should-run-tests == 'true'
    
    steps:
      # Checkout code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Setup pnpm
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # Cache dependencies
      - name: ğŸ“‚ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            apps/unified/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      
      # Install dependencies
      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile
      
      # Run unit tests (if script exists)
      - name: ğŸ§ª Run Unit Tests
        if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'unit' || github.event.inputs.test_type == ''
        run: |
          echo "ğŸ§ª Checking for unit tests..."
          if pnpm run --if-present test:unit; then
            echo "âœ… Unit tests completed"
          else
            echo "â„¹ï¸ No unit tests found - skipping"
          fi

  # ===================================
  # E2E TESTS
  # ===================================
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    needs: code-quality
    if: needs.code-quality.outputs.should-run-tests == 'true'
    
    steps:
      # Checkout code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Setup pnpm
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # Cache dependencies
      - name: ğŸ“‚ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            apps/unified/node_modules
            apps/unified/.next/cache
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      
      # Install dependencies
      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile
      
      # Install Playwright browsers
      - name: ğŸ­ Install Playwright Browsers
        if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'e2e' || github.event.inputs.test_type == ''
        run: pnpm exec playwright install --with-deps
      
      # Run E2E tests
      - name: ğŸ­ Run E2E Tests
        if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'e2e' || github.event.inputs.test_type == ''
        run: |
          echo "ğŸ­ Running E2E tests..."
          pnpm test:e2e
          echo "âœ… E2E tests completed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'dummy-url' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}
          CI: true
      
      # Upload test results
      - name: ğŸ“Š Upload E2E Test Results
        if: always() && (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'e2e' || github.event.inputs.test_type == '')
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # ===================================
  # SECURITY SCAN
  # ===================================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    if: needs.code-quality.outputs.should-run-tests == 'true'
    
    steps:
      # Checkout code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      # Setup pnpm
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
      
      # Install dependencies
      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile
      
      # Security audit
      - name: ğŸ”’ Run Security Audit
        run: |
          echo "ğŸ”’ Running security audit..."
          pnpm audit --audit-level high
          echo "âœ… Security audit completed"
        continue-on-error: true

  # ===================================
  # SUMMARY REPORT
  # ===================================
  test-summary:
    name: ğŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, e2e-tests, security-scan]
    if: always()
    
    steps:
      # Create summary
      - name: ğŸ“‹ Create Test Summary
        run: |
          echo "## ğŸ§ª Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Code Quality
          if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "| ğŸ“‹ Code Quality | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“‹ Code Quality | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Unit Tests
          if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
            echo "| ğŸ§ª Unit Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.unit-tests.result }}" == "skipped" ]]; then
            echo "| ğŸ§ª Unit Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ§ª Unit Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # E2E Tests
          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "| ğŸ­ E2E Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
            echo "| ğŸ­ E2E Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ­ E2E Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Security Scan
          if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "| ğŸ”’ Security Scan | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.security-scan.result }}" == "skipped" ]]; then
            echo "| ğŸ”’ Security Scan | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ”’ Security Scan | âš ï¸ Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
      
      # Set overall status
      - name: âœ… Overall Status Check
        run: |
          if [[ "${{ needs.code-quality.result }}" == "success" ]] && 
             [[ "${{ needs.e2e-tests.result }}" == "success" || "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
            echo "ğŸ‰ All quality checks passed!"
            exit 0
          else
            echo "âŒ Some quality checks failed!"
            exit 1
          fi